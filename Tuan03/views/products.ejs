<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Product Management</title>
    <link rel="shortcut icon" href="/images/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="/stylesheets/style.css" />
</head>

<body>
    <div class="container">
        <div class="topbar">
            <div class="user-info">
                <h1>System Management</h1>
                <span class="badge">
                    üë§ <%= user.username %> (<%= user.role %>)
                </span>
            </div>
            <div class="nav-links">
                <a href="/" class="btn primary">Products</a>
                <a href="/categories" class="btn">Categories</a>
                <form action="/logout" method="post" style="display: inline;">
                    <button type="submit" class="btn danger">Logout</button>
                </form>
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid var(--border); margin-bottom: 20px;">
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #dbeafe;">üì¶</div>
                <div class="stat-content">
                    <div class="stat-label">Total Products</div>
                    <div class="stat-value"><%= products.length %></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #dcfce7;">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-label">In Stock</div>
                    <div class="stat-value"><%= products.filter(p => p.quantity >= 5).length %></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fef3c7;">‚ö†Ô∏è</div>
                <div class="stat-content">
                    <div class="stat-label">Low Stock</div>
                    <div class="stat-value"><%= products.filter(p => p.quantity > 0 && p.quantity < 5).length %></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fee2e2;">‚ùå</div>
                <div class="stat-content">
                    <div class="stat-label">Out of Stock</div>
                    <div class="stat-value"><%= products.filter(p => p.quantity === 0).length %></div>
                </div>
            </div>
        </div>

        <!-- Search Filters -->
        <h2 style="margin-top: 24px; margin-bottom: 16px;">üîç Search & Filter</h2>
        <div class="card" style="margin-bottom: 20px;">
            <form method="GET" action="/" class="form-grid"
                style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))">
                <input type="text" name="search" placeholder="Product name..." value="<%= query.search || '' %>">

                <div>
                    <label>Category</label>
                    <select name="categoryId">
                        <option value="">-- Select category --</option>
                        <% categories.forEach(cat=> { %>
                            <option value="<%= cat.categoryId %>" <%=query.categoryId==cat.categoryId ? 'selected' : ''
                                %>>
                                <%= cat.name %>
                            </option>
                            <% }) %>
                    </select>
                </div>

                <input type="number" name="minPrice" placeholder="Min price" value="<%= query.minPrice || '' %>">
                <input type="number" name="maxPrice" placeholder="Max price" value="<%= query.maxPrice || '' %>">

                <button type="submit" class="btn primary">Search</button>
                <a href="/" class="btn">Clear filters</a>
            </form>
        </div>

        <% if (user.role==='admin' ) { %>
            <h2 style="margin-top: 24px; margin-bottom: 16px;">‚ûï <%= editingProduct ? 'Edit Product' : 'Add New Product' %></h2>
            <div class="card">
                <form action="<%= editingProduct ? ('/edit/' + editingProduct.id) : '/add' %>" method="post"
                    enctype="multipart/form-data">
                    <div class="form-grid">
                        <div>
                            <label>Product Name *</label>
                            <input type="text" name="name" placeholder="Enter product name" required
                                value="<%= editingProduct ? editingProduct.name : '' %>">
                        </div>
                        <div>
                            <label>Category *</label>
                            <select name="categoryId" required>
                                <option value="">-- Select category --</option>
                                <% categories.forEach(cat=> { %>
                                    <option value="<%= cat.categoryId %>" <%=(editingProduct &&
                                        editingProduct.categoryId==cat.categoryId) ? 'selected' : '' %>>
                                        <%= cat.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>
                        <div>
                            <label>Price (‚Ç´) *</label>
                            <input type="number" name="price" placeholder="Enter price" required min="0"
                                value="<%= editingProduct ? editingProduct.price : '' %>">
                        </div>
                        <div>
                            <label>Quantity *</label>
                            <input type="number" name="quantity" placeholder="Enter quantity" required min="0"
                                value="<%= editingProduct ? editingProduct.quantity : '' %>">
                        </div>
                        <div>
                            <label>Image</label>
                            <input type="file" name="image" accept="image/*" id="imageInput"
                                onchange="previewImage(event)">
                            <% if (editingProduct && editingProduct.image_url) { %>
                                <div style="margin-top: 12px;">
                                    <label style="display: block; margin-bottom: 6px;">Current Image:</label>
                                    <img src="<%= editingProduct.image_url %>" alt="Current" id="currentImage"
                                        style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border);">
                                </div>
                                <% } %>
                                    <div id="imagePreview" style="margin-top: 12px; display: none;">
                                        <label style="display: block; margin-bottom: 6px;">Preview:</label>
                                        <img id="preview" src="" alt="Preview"
                                            style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border);">
                                    </div>
                        </div>
                    </div>
                    <button class="btn primary" type="submit" style="margin-top: 16px;">
                        <%= editingProduct ? 'Update Product' : 'Add Product' %>
                    </button>
                    <% if (editingProduct) { %>
                        <a href="/" class="btn" style="margin-left: 8px;">Cancel</a>
                        <% } %>
                </form>
            </div>
            <% } %>

                <h2 style="margin-top: 24px; margin-bottom: 16px;">üìã Products List</h2>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <% if (user.role==='admin' ) { %>
                                    <th>Actions</th>
                                    <% } %>
                            </tr>
                        </thead>
                        <tbody>
                            <% products.forEach(p=> { %>
                                <tr>
                                    <td>
                                        <% if (p.image_url) { %>
                                            <img src="<%= p.image_url %>" alt="<%= p.name %>"
                                                style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                            <% } else { %>
                                                <div
                                                    style="width: 60px; height: 60px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.75rem;">
                                                    No image</div>
                                                <% } %>
                                    </td>
                                    <td>
                                        <%= p.name %>
                                    </td>
                                    <td>
                                        <%= p.price.toLocaleString() %> ƒë
                                    </td>
                                    <td>
                                        <%= p.quantity %>
                                    </td>
                                    <td>
                                        <% if (p.quantity==0) { %>
                                            <span class="badge danger">Out of stock</span>
                                            <% } else if (p.quantity < 5) { %>
                                                <span class="badge warning">Low stock</span>
                                                <% } else { %>
                                                    <span class="badge success">In stock</span>
                                                    <% } %>
                                    </td>
                                    <% if (user.role==='admin' ) { %>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="/edit/<%= p.id %>" class="btn">Edit</a>
                                                <form action="/delete/<%= p.id %>" method="post" style="display:inline">
                                                    <button class="btn danger"
                                                        onclick="return confirm('Are you sure you want to delete this product?')">Delete</button>
                                                </form>
                                            </div>
                                        </td>
                                        <% } %>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>

                <div class="pagination" style="margin-top: 15px; display: flex; gap: 5px;">
                    <% for(let i=1; i <=totalPages; i++) { %>
                        <a href="?page=<%= i %>&search=<%= query.search || '' %>&categoryId=<%= query.categoryId || '' %>"
                            class="btn <%= currentPage == i ? 'primary' : '' %>">
                            <%= i %>
                        </a>
                        <% } %>
                </div>
    </div>

    <script>
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('preview');
            const previewContainer = document.getElementById('imagePreview');
            const currentImage = document.getElementById('currentImage');

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                    if (currentImage) {
                        currentImage.style.opacity = '0.5';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
                if (currentImage) {
                    currentImage.style.opacity = '1';
                }
            }
        }
    </script>
</body>

</html>